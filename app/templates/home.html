{{ template "header.html" }}

<div class="back min-vh-100">
    <div class="container-main bg-white shadow-lg rounded p-5 my-5 mx-auto">
        <h2 class="mb-4">Share Secure Password</h2>
        
        <form id="password-form" role="form" novalidate>
            <div class="messages"></div>

            <!-- Error Display -->
            {{ with .Errors.Email }}
            <div class="alert alert-danger" role="alert">
                <p class="mb-0">{{ . }}</p>
            </div>
            {{ end }}

            <!-- Email Distribution Toggle -->
            <div class="section-group">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <h5 class="section-title mb-2">
                            <i class="fas fa-envelope me-2"></i>
                            Email Notification
                        </h5>
                        <p class="text-muted mb-0">
                            Send the secure link directly to the recipient's email
                        </p>
                    </div>
                    <div class="ms-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" 
                                   name="enableEmail" 
                                   class="form-check-input fs-4" 
                                   id="enableEmail" 
                                   aria-describedby="emailToggleHelp"
                                   style="transform: scale(1.5);">
                            <label for="enableEmail" class="form-check-label visually-hidden">
                                Send email notification to recipient
                            </label>
                        </div>
                    </div>
                </div>
                <div id="emailToggleHelp" class="form-text mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    When enabled, the recipient will receive an email with the secure link
                </div>
            </div>

            <!-- Sender Information (shown when email enabled) -->
            <div id="sender-section" class="section-group">
                <h5 class="section-title">Your Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="firstname" class="form-label">
                                Your First Name
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Used to identify you to the recipient"
                                        aria-label="Help about your first name">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="firstname" 
                                   type="text" 
                                   class="form-control" 
                                   name="firstname" 
                                   placeholder="Enter your first name"
                                   aria-describedby="firstnameError">
                            <div id="firstnameError" class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="email" class="form-label">
                                Your Email
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Only used to send notification emails - not stored or shared"
                                        aria-label="Help about your email">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="email" 
                                   type="email" 
                                   name="email" 
                                   class="form-control" 
                                   placeholder="your.email@example.com"
                                   aria-describedby="emailError">
                            <div id="emailError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passphrase (always visible) -->
            <div class="section-group">
                <h5 class="section-title">Security</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_lastname" class="form-label">
                                Passphrase (Optional)
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Optional additional verification - recipient must enter this to access the password"
                                        aria-label="Help about passphrase">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="other_lastname" 
                                   type="text" 
                                   name="other_lastname" 
                                   class="form-control" 
                                   placeholder="Enter a passphrase"
                                   aria-describedby="passphraseHelp">
                            <div id="passphraseHelp" class="form-text">
                                Used as additional security verification
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="max_view_count" class="form-label">
                                Max View Count (Optional)
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Maximum number of times this message can be accessed before automatic deletion (1-100)"
                                        aria-label="Help about max view count">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            {{ with .Errors.max_view_count }}
                            <div class="alert alert-danger" role="alert">
                                <p class="mb-0">{{ . }}</p>
                            </div>
                            {{ end }}
                            <input id="max_view_count" 
                                   type="number" 
                                   name="max_view_count" 
                                   class="form-control" 
                                   placeholder="5"
                                   min="1"
                                   max="100"
                                   aria-describedby="maxViewCountHelp maxViewCountError">
                            <div id="maxViewCountHelp" class="form-text">
                                Leave empty to use default (5 views)
                            </div>
                            <div id="maxViewCountError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipient Information (shown when email enabled) -->
            <div id="recipient-section" class="section-group">
                <h5 class="section-title">Recipient Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_firstname" class="form-label">
                                Recipient's First Name
                                <span class="text-danger">*</span>
                            </label>
                            <input id="other_firstname" 
                                   type="text" 
                                   name="other_firstname" 
                                   class="form-control" 
                                   placeholder="Recipient's first name"
                                   aria-describedby="otherFirstnameError">
                            <div id="otherFirstnameError" class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_email" class="form-label">
                                Recipient's Email
                                <span class="text-danger">*</span>
                            </label>
                            <input id="other_email" 
                                   type="email" 
                                   name="other_email" 
                                   class="form-control" 
                                   placeholder="recipient@example.com"
                                   aria-describedby="otherEmailError">
                            <div id="otherEmailError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anti-spam verification (shown when email enabled) -->
            <div id="verification-section" class="section-group">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="color" class="form-label">
                                Verification Question
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Simple verification to prevent automated spam"
                                        aria-label="Help about verification">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input type="text" 
                                   id="color"
                                   class="form-control" 
                                   name="color" 
                                   aria-describedby="colorHelp colorError">
                            <div id="colorHelp" class="form-text">
                                <span id="antispam-question"></span>
                            </div>
                            <input type="hidden" id="question-id" name="questionId" value="">
                            <div id="colorError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Content -->
            <div class="section-group">
                <h5 class="section-title">Secure Message</h5>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-4">
                            {{ with .Errors.Content }}
                            <div class="alert alert-danger" role="alert">
                                <p class="mb-0">{{ . }}</p>
                            </div>
                            {{ end }}
                            <label for="form_message" class="form-label">
                                Password or Secret Message
                                <span class="text-danger">*</span>
                            </label>
                            <textarea id="form_message" 
                                      name="content" 
                                      class="form-control" 
                                      placeholder="Enter the password or secret message to share securely..." 
                                      rows="4" 
                                      required 
                                      aria-describedby="messageHelp messageError">{{.Content}}</textarea>
                            <div id="messageHelp" class="form-text">
                                This will be encrypted and can be accessed up to the specified view count before being automatically deleted
                            </div>
                            <div id="messageError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cloudflare Turnstile -->
            <div id="turnstile-section" class="section-group">
                <h5 class="section-title">Security Verification</h5>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-3">
                            <div class="cf-turnstile" 
                                 data-sitekey="0x4AAAAAABgIcIPaICA7z6Yf" 
                                 data-callback="onTurnstileSuccess"
                                 data-error-callback="onTurnstileError"
                                 data-expired-callback="onTurnstileExpired">
                            </div>
                            <div id="turnstile-error" class="invalid-feedback" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="row">
                <div class="col-12">
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" id="submit-button" disabled>
                            <i class="fas fa-lock me-2"></i>
                            Create Secure Link
                        </button>
                    </div>
                    <div id="success" class="mt-3"></div>
                </div>
            </div>

        </form>

        <div class="row mt-4">
            <div class="col-12">
                <p class="text-muted small">
                    <strong>*</strong> Required fields when email notification is enabled
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Cloudflare Turnstile callback functions
let turnstileToken = null;

function onTurnstileSuccess(token) {
    turnstileToken = token;
    // Only enable submit button if email notifications are enabled (requiring Turnstile)
    const emailEnabled = document.getElementById('enableEmail').checked;
    if (emailEnabled) {
        document.getElementById('submit-button').disabled = false;
    }
    document.getElementById('turnstile-error').style.display = 'none';
}

function onTurnstileError() {
    turnstileToken = null;
    // Only disable submit button if email notifications are enabled (requiring Turnstile)
    const emailEnabled = document.getElementById('enableEmail').checked;
    if (emailEnabled) {
        document.getElementById('submit-button').disabled = true;
    }
    document.getElementById('turnstile-error').textContent = 'Verification failed. Please try again.';
    document.getElementById('turnstile-error').style.display = 'block';
}

function onTurnstileExpired() {
    turnstileToken = null;
    // Only disable submit button if email notifications are enabled (requiring Turnstile)
    const emailEnabled = document.getElementById('enableEmail').checked;
    if (emailEnabled) {
        document.getElementById('submit-button').disabled = true;
    }
    document.getElementById('turnstile-error').textContent = 'Verification expired. Please complete the challenge again.';
    document.getElementById('turnstile-error').style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
    
    // Antispam question rotation system (questions only, answers validated server-side)
    const antispamQuestions = [
        "What color is the sky? (blue, green, red, or orange)",
        "What is 2 + 2?",
        "How many days are in a week?", 
        "What animal says meow?",
        "What do you use to write? (pen, car, house, or tree)",
        "How many legs does a dog have?"
    ];
    
    // Select question based on current hour (rotates every hour)
    const now = new Date();
    const questionIndex = now.getHours() % antispamQuestions.length;
    
    // Set the question and question ID
    document.getElementById('antispam-question').textContent = antispamQuestions[questionIndex];
    document.getElementById('question-id').value = questionIndex;
    const form = document.getElementById('password-form');
    const emailToggle = document.getElementById('enableEmail');
    const senderSection = document.getElementById('sender-section');
    const recipientSection = document.getElementById('recipient-section');
    const verificationSection = document.getElementById('verification-section');
    
    // Elements that are required when email is enabled
    const emailRequiredFields = [
        document.getElementById('firstname'),
        document.getElementById('email'),
        document.getElementById('other_firstname'),
        document.getElementById('other_email'),
        document.getElementById('color')
    ];
    
    // Elements that should be hidden when email is disabled
    const turnstileSection = document.getElementById('turnstile-section');
    const emailDependentElements = [senderSection, recipientSection, verificationSection, turnstileSection];
    
    // Initialize tooltips
    const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipElements.forEach(element => {
        new bootstrap.Tooltip(element);
    });
    
    // Handle email toggle
    function updateEmailDependentFields() {
        const emailEnabled = emailToggle.checked;
        const submitButton = document.getElementById('submit-button');
        
        // Show/hide email-dependent sections
        emailDependentElements.forEach(element => {
            if (emailEnabled) {
                element.style.display = 'block';
                element.setAttribute('aria-hidden', 'false');
            } else {
                element.style.display = 'none';
                element.setAttribute('aria-hidden', 'true');
            }
        });
        
        // Update required attributes and clear values when hiding
        emailRequiredFields.forEach(field => {
            if (emailEnabled) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
                field.value = '';
                field.classList.remove('is-invalid');
            }
        });
        
        // Reset Turnstile when email is disabled
        if (!emailEnabled) {
            turnstileToken = null;
            document.getElementById('turnstile-error').style.display = 'none';
            if (window.turnstile) {
                window.turnstile.reset();
            }
            // Enable submit button when email notifications are disabled (no Turnstile required)
            submitButton.disabled = false;
        } else {
            // Disable submit button when email is enabled until Turnstile is completed
            submitButton.disabled = !turnstileToken;
        }
        
        // Visual indicators are now handled by showing/hiding entire sections
    }
    
    // Email toggle event listener
    emailToggle.addEventListener('change', updateEmailDependentFields);
    
    // Initialize on page load
    updateEmailDependentFields();
    
    // Form validation and API submission
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        let isValid = true;
        
        // Clear previous validation states and messages
        form.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        document.querySelector('.messages').innerHTML = '';
        document.getElementById('success').innerHTML = '';
        
        // Validate required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Validate email fields
        const emailFields = form.querySelectorAll('input[type="email"][required]');
        emailFields.forEach(field => {
            if (field.value && !field.checkValidity()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Color field validation is handled server-side since antispam questions vary
        
        // Validate Turnstile token (only required when email notifications are enabled)
        const emailEnabled = emailToggle.checked;
        if (emailEnabled && !turnstileToken) {
            document.getElementById('turnstile-error').textContent = 'Please complete the security verification.';
            document.getElementById('turnstile-error').style.display = 'block';
            isValid = false;
        }

        if (!isValid) {
            // Focus first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
            }
            form.classList.add('was-validated');
            return;
        }
        
        // Disable submit button and show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Secure Link...';
        
        try {
            // Build API request payload
            const emailEnabled = emailToggle.checked;
            const payload = {
                content: document.getElementById('form_message').value.trim(),
                sendNotification: emailEnabled,
                turnstileToken: turnstileToken
            };
            
            // Add max view count if provided
            const maxViewCount = document.getElementById('max_view_count').value.trim();
            if (maxViewCount) {
                payload.maxViewCount = parseInt(maxViewCount, 10);
            }

            // Add passphrase if provided
            const passphrase = document.getElementById('other_lastname').value.trim();
            if (passphrase) {
                payload.passphrase = passphrase;
            }
            
            // Add sender and recipient info if email enabled
            if (emailEnabled) {
                payload.sender = {
                    name: document.getElementById('firstname').value.trim(),
                    email: document.getElementById('email').value.trim()
                };
                payload.recipient = {
                    name: document.getElementById('other_firstname').value.trim(),
                    email: document.getElementById('other_email').value.trim()
                };
                payload.antiSpamAnswer = document.getElementById('color').value.trim();
                payload.questionId = parseInt(document.getElementById('question-id').value);
            }
            
            // Make API call
            const response = await fetch('/api/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Success - show the secure link
                const successDiv = document.getElementById('success');
                successDiv.innerHTML = `
                    <div class="alert alert-success" role="alert">
                        <h5 class="alert-heading">
                            <i class="fas fa-check-circle me-2"></i>
                            Secure Link Created Successfully!
                        </h5>
                        <hr>
                        <p class="mb-3">Your secure message has been encrypted and is ready to share:</p>
                        <div class="input-group mb-3" style="border-radius: 12px; overflow: hidden;">
                            <input type="text" class="form-control font-monospace" 
                                   value="${result.webUrl}" 
                                   id="secure-url" readonly
                                   style="border-right: none !important; border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important;">
                            <button class="btn" 
                                    type="button" onclick="copyToClipboard()" 
                                    title="Copy to clipboard"
                                    style="border: 2px solid #e9ecef !important; border-left: none !important; border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; border-top-right-radius: 12px !important; border-bottom-right-radius: 12px !important; background: #f8f9fa !important; color: #6c757d !important; transform: none !important;"
                                    onmouseover="this.style.backgroundColor='#e9ecef'; this.style.color='#495057'; this.style.transform='none'"
                                    onmouseout="this.style.backgroundColor='#f8f9fa'; this.style.color='#6c757d'; this.style.transform='none'">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        ${result.notificationSent ? 
                            '<p class="mb-0 text-success"><i class="fas fa-envelope-check me-1"></i>Email notification sent successfully!</p>' : 
                            ''}
                        <p class="mb-0 text-muted small">
                            <i class="fas fa-clock me-1"></i>
                            Expires: ${new Date(result.expiresAt).toLocaleString()}
                        </p>
                    </div>
                `;
                
                // Reset form
                form.reset();
                updateEmailDependentFields();
                form.classList.remove('was-validated');
                
                // Reset Turnstile
                turnstileToken = null;
                if (window.turnstile) {
                    window.turnstile.reset();
                }
                // Update submit button state based on email notification setting
                updateEmailDependentFields();
                
                // Scroll to success message
                successDiv.scrollIntoView({ behavior: 'smooth' });
                
            } else {
                // Error handling
                let errorMessage = 'An error occurred while creating the secure link.';
                
                if (result.details) {
                    // Validation errors
                    const errorList = Object.values(result.details).join('<br>');
                    errorMessage = `<strong>Validation Error:</strong><br>${errorList}`;
                } else if (result.message) {
                    errorMessage = result.message;
                }
                
                document.querySelector('.messages').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${errorMessage}
                    </div>
                `;
                
                // Scroll to error message
                document.querySelector('.messages').scrollIntoView({ behavior: 'smooth' });
            }
            
        } catch (error) {
            console.error('Network error:', error);
            document.querySelector('.messages').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Network error: Unable to connect to the server. Please try again.
                </div>
            `;
            document.querySelector('.messages').scrollIntoView({ behavior: 'smooth' });
        } finally {
            // Restore button text
            submitButton.innerHTML = originalButtonText;
            
            // Reset Turnstile on error (user needs to complete challenge again)
            if (!document.getElementById('success').innerHTML) {
                turnstileToken = null;
                if (window.turnstile) {
                    window.turnstile.reset();
                }
            }
            
            // Update submit button state based on email notification setting
            updateEmailDependentFields();
        }
        
        form.classList.add('was-validated');
    });
    
    // Add copy to clipboard functionality
    window.copyToClipboard = function() {
        const urlInput = document.getElementById('secure-url');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            document.execCommand('copy');
            
            // Show feedback
            const copyButton = event.target.closest('button');
            const originalText = copyButton.innerHTML;
            const originalBg = copyButton.style.backgroundColor;
            const originalColor = copyButton.style.color;
            
            copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
            copyButton.style.backgroundColor = '#198754';
            copyButton.style.color = '#fff';
            copyButton.style.borderColor = '#198754';
            
            setTimeout(() => {
                copyButton.innerHTML = originalText;
                copyButton.style.backgroundColor = originalBg;
                copyButton.style.color = originalColor;
                copyButton.style.borderColor = '#e9ecef';
            }, 2000);
            
        } catch (err) {
            console.error('Failed to copy: ', err);
            alert('Failed to copy URL to clipboard');
        }
    };
});
</script>


</body>
</html>