{{ template "header.html" }}

<div class="back min-vh-100">
    <div class="container-main bg-white shadow-lg rounded p-5 my-5 mx-auto">
        <h2 class="mb-4">Share Secure Password</h2>
        
        <form id="password-form" method="post" action="/" role="form" novalidate>
            <div class="messages"></div>

            <!-- Error Display -->
            {{ with .Errors.Email }}
            <div class="alert alert-danger" role="alert">
                <p class="mb-0">{{ . }}</p>
            </div>
            {{ end }}

            <!-- Email Distribution Toggle -->
            <div class="section-group">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <h5 class="section-title mb-2">
                            <i class="fas fa-envelope me-2"></i>
                            Email Notification
                        </h5>
                        <p class="text-muted mb-0">
                            Send the secure link directly to the recipient's email
                        </p>
                    </div>
                    <div class="ms-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" 
                                   name="enableEmail" 
                                   class="form-check-input fs-4" 
                                   id="enableEmail" 
                                   aria-describedby="emailToggleHelp"
                                   style="transform: scale(1.5);">
                            <label for="enableEmail" class="form-check-label visually-hidden">
                                Send email notification to recipient
                            </label>
                        </div>
                    </div>
                </div>
                <div id="emailToggleHelp" class="form-text mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    When enabled, the recipient will receive an email with the secure link
                </div>
            </div>

            <!-- Sender Information (shown when email enabled) -->
            <div id="sender-section" class="section-group">
                <h5 class="section-title">Your Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="firstname" class="form-label">
                                Your First Name
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Used to identify you to the recipient"
                                        aria-label="Help about your first name">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="firstname" 
                                   type="text" 
                                   class="form-control" 
                                   name="firstname" 
                                   placeholder="Enter your first name"
                                   aria-describedby="firstnameError">
                            <div id="firstnameError" class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="email" class="form-label">
                                Your Email
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Only used to send notification emails - not stored or shared"
                                        aria-label="Help about your email">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="email" 
                                   type="email" 
                                   name="email" 
                                   class="form-control" 
                                   placeholder="your.email@example.com"
                                   aria-describedby="emailError">
                            <div id="emailError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passphrase (always visible) -->
            <div class="section-group">
                <h5 class="section-title">Security</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_lastname" class="form-label">
                                Passphrase (Optional)
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Optional additional verification - recipient must enter this to access the password"
                                        aria-label="Help about passphrase">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="other_lastname" 
                                   type="text" 
                                   name="other_lastname" 
                                   class="form-control" 
                                   placeholder="Enter a passphrase"
                                   aria-describedby="passphraseHelp">
                            <div id="passphraseHelp" class="form-text">
                                Used as additional security verification
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipient Information (shown when email enabled) -->
            <div id="recipient-section" class="section-group">
                <h5 class="section-title">Recipient Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_firstname" class="form-label">
                                Recipient's First Name
                                <span class="text-danger">*</span>
                            </label>
                            <input id="other_firstname" 
                                   type="text" 
                                   name="other_firstname" 
                                   class="form-control" 
                                   placeholder="Recipient's first name"
                                   aria-describedby="otherFirstnameError">
                            <div id="otherFirstnameError" class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_email" class="form-label">
                                Recipient's Email
                                <span class="text-danger">*</span>
                            </label>
                            <input id="other_email" 
                                   type="email" 
                                   name="other_email" 
                                   class="form-control" 
                                   placeholder="recipient@example.com"
                                   aria-describedby="otherEmailError">
                            <div id="otherEmailError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anti-spam verification (shown when email enabled) -->
            <div id="verification-section" class="section-group">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="color" class="form-label">
                                Verification Question
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Simple verification to prevent automated spam"
                                        aria-label="Help about verification">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input type="text" 
                                   id="color"
                                   class="form-control" 
                                   name="color" 
                                   pattern="[ ]*(red|blue|orange|green)[ ]*" 
                                   aria-describedby="colorHelp colorError">
                            <div id="colorHelp" class="form-text">
                                What color is the sky? (blue, green, red, or orange)
                            </div>
                            <div id="colorError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Content -->
            <div class="section-group">
                <h5 class="section-title">Secure Message</h5>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-4">
                            {{ with .Errors.Content }}
                            <div class="alert alert-danger" role="alert">
                                <p class="mb-0">{{ . }}</p>
                            </div>
                            {{ end }}
                            <label for="form_message" class="form-label">
                                Password or Secret Message
                                <span class="text-danger">*</span>
                            </label>
                            <textarea id="form_message" 
                                      name="content" 
                                      class="form-control" 
                                      placeholder="Enter the password or secret message to share securely..." 
                                      rows="4" 
                                      required 
                                      aria-describedby="messageHelp messageError">{{.Content}}</textarea>
                            <div id="messageHelp" class="form-text">
                                This will be encrypted and can only be accessed once by the recipient
                            </div>
                            <div id="messageError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="row">
                <div class="col-12">
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-lock me-2"></i>
                            Create Secure Link
                        </button>
                    </div>
                    <div id="success" class="mt-3"></div>
                </div>
            </div>

            <!-- Hidden field for backend compatibility -->
            <input type="hidden" name="skipEmail" id="skipEmailHidden" value="true">
        </form>

        <div class="row mt-4">
            <div class="col-12">
                <p class="text-muted small">
                    <strong>*</strong> Required fields when email notification is enabled
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('password-form');
    const emailToggle = document.getElementById('enableEmail');
    const skipEmailHidden = document.getElementById('skipEmailHidden');
    const senderSection = document.getElementById('sender-section');
    const recipientSection = document.getElementById('recipient-section');
    const verificationSection = document.getElementById('verification-section');
    
    // Elements that are required when email is enabled
    const emailRequiredFields = [
        document.getElementById('firstname'),
        document.getElementById('email'),
        document.getElementById('other_firstname'),
        document.getElementById('other_email'),
        document.getElementById('color')
    ];
    
    // Elements that should be hidden when email is disabled
    const emailDependentElements = [senderSection, recipientSection, verificationSection];
    
    // Initialize tooltips
    const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipElements.forEach(element => {
        new bootstrap.Tooltip(element);
    });
    
    // Handle email toggle
    function updateEmailDependentFields() {
        const emailEnabled = emailToggle.checked;
        
        // Update hidden field for backend (send empty string when email enabled, "true" when disabled)
        skipEmailHidden.value = emailEnabled ? '' : 'true';
        
        // Show/hide email-dependent sections
        emailDependentElements.forEach(element => {
            if (emailEnabled) {
                element.style.display = 'block';
                element.setAttribute('aria-hidden', 'false');
            } else {
                element.style.display = 'none';
                element.setAttribute('aria-hidden', 'true');
            }
        });
        
        // Update required attributes and clear values when hiding
        emailRequiredFields.forEach(field => {
            if (emailEnabled) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
                field.value = '';
                field.classList.remove('is-invalid');
            }
        });
        
        // Visual indicators are now handled by showing/hiding entire sections
    }
    
    // Email toggle event listener
    emailToggle.addEventListener('change', updateEmailDependentFields);
    
    // Initialize on page load
    updateEmailDependentFields();
    
    // Form validation
    form.addEventListener('submit', function(event) {
        let isValid = true;
        
        // Clear previous validation states
        form.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        
        // Validate required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Validate email fields
        const emailFields = form.querySelectorAll('input[type="email"][required]');
        emailFields.forEach(field => {
            if (field.value && !field.checkValidity()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Validate color field pattern
        const colorField = document.getElementById('color');
        if (colorField.hasAttribute('required') && colorField.value) {
            const pattern = new RegExp(colorField.getAttribute('pattern'));
            if (!pattern.test(colorField.value)) {
                colorField.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
            
            // Focus first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
            }
        }
        
        form.classList.add('was-validated');
    });
});
</script>


</body>
</html>