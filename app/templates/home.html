{{ template "header.html" }}

<div class="back min-vh-100">
    <div class="container-main bg-white shadow-lg rounded p-5 my-5 mx-auto">
        <h2 class="mb-4">Share Secure Password</h2>
        
        <form id="password-form" method="post" action="/" role="form" novalidate>
            <div class="messages"></div>

            <!-- Error Display -->
            {{ with .Errors.Email }}
            <div class="alert alert-danger" role="alert">
                <p class="mb-0">{{ . }}</p>
            </div>
            {{ end }}

            <!-- Email Distribution Toggle -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="form-check form-switch">
                        <input type="checkbox" 
                               name="enableEmail" 
                               class="form-check-input" 
                               id="enableEmail" 
                               aria-describedby="emailToggleHelp">
                        <label for="enableEmail" class="form-check-label">
                            Send email notification to recipient
                        </label>
                        <div id="emailToggleHelp" class="form-text">
                            When enabled, the recipient will receive an email with the secure link
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sender Information (shown when email enabled) -->
            <div id="sender-section" class="section-group">
                <h5 class="section-title">Your Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="firstname" class="form-label">
                                Your First Name
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Used to identify you to the recipient"
                                        aria-label="Help about your first name">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="firstname" 
                                   type="text" 
                                   class="form-control" 
                                   name="firstname" 
                                   placeholder="Enter your first name"
                                   aria-describedby="firstnameError">
                            <div id="firstnameError" class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="email" class="form-label">
                                Your Email
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Only used to send notification emails - not stored or shared"
                                        aria-label="Help about your email">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="email" 
                                   type="email" 
                                   name="email" 
                                   class="form-control" 
                                   placeholder="your.email@example.com"
                                   aria-describedby="emailError">
                            <div id="emailError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passphrase (always visible) -->
            <div class="section-group">
                <h5 class="section-title">Security</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_lastname" class="form-label">
                                Passphrase (Optional)
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Optional additional verification - recipient must enter this to access the password"
                                        aria-label="Help about passphrase">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input id="other_lastname" 
                                   type="text" 
                                   name="other_lastname" 
                                   class="form-control" 
                                   placeholder="Enter a passphrase"
                                   aria-describedby="passphraseHelp">
                            <div id="passphraseHelp" class="form-text">
                                Used as additional security verification
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipient Information (shown when email enabled) -->
            <div id="recipient-section" class="section-group">
                <h5 class="section-title">Recipient Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_firstname" class="form-label">
                                Recipient's First Name
                                <span class="text-danger">*</span>
                            </label>
                            <input id="other_firstname" 
                                   type="text" 
                                   name="other_firstname" 
                                   class="form-control" 
                                   placeholder="Recipient's first name"
                                   aria-describedby="otherFirstnameError">
                            <div id="otherFirstnameError" class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="other_email" class="form-label">
                                Recipient's Email
                                <span class="text-danger">*</span>
                            </label>
                            <input id="other_email" 
                                   type="email" 
                                   name="other_email" 
                                   class="form-control" 
                                   placeholder="recipient@example.com"
                                   aria-describedby="otherEmailError">
                            <div id="otherEmailError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anti-spam verification (shown when email enabled) -->
            <div id="verification-section" class="section-group">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="color" class="form-label">
                                Verification Question
                                <span class="text-danger">*</span>
                                <button type="button" 
                                        class="btn btn-link btn-sm p-0 ms-1" 
                                        data-bs-toggle="tooltip" 
                                        title="Simple verification to prevent automated spam"
                                        aria-label="Help about verification">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </label>
                            <input type="text" 
                                   id="color"
                                   class="form-control" 
                                   name="color" 
                                   pattern="[ ]*(red|blue|orange|green)[ ]*" 
                                   aria-describedby="colorHelp colorError">
                            <div id="colorHelp" class="form-text">
                                What color is the sky? (blue, green, red, or orange)
                            </div>
                            <div id="colorError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Content -->
            <div class="section-group">
                <h5 class="section-title">Secure Message</h5>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-4">
                            {{ with .Errors.Content }}
                            <div class="alert alert-danger" role="alert">
                                <p class="mb-0">{{ . }}</p>
                            </div>
                            {{ end }}
                            <label for="form_message" class="form-label">
                                Password or Secret Message
                                <span class="text-danger">*</span>
                            </label>
                            <textarea id="form_message" 
                                      name="content" 
                                      class="form-control" 
                                      placeholder="Enter the password or secret message to share securely..." 
                                      rows="4" 
                                      required 
                                      aria-describedby="messageHelp messageError">{{.Content}}</textarea>
                            <div id="messageHelp" class="form-text">
                                This will be encrypted and can only be accessed once by the recipient
                            </div>
                            <div id="messageError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="row">
                <div class="col-12">
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-lock me-2"></i>
                            Create Secure Link
                        </button>
                    </div>
                    <div id="success" class="mt-3"></div>
                </div>
            </div>

            <!-- Hidden field for backend compatibility -->
            <input type="hidden" name="skipEmail" id="skipEmailHidden" value="true">
        </form>

        <div class="row mt-4">
            <div class="col-12">
                <p class="text-muted small">
                    <strong>*</strong> Required fields when email notification is enabled
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('password-form');
    const emailToggle = document.getElementById('enableEmail');
    const skipEmailHidden = document.getElementById('skipEmailHidden');
    const senderSection = document.getElementById('sender-section');
    const recipientSection = document.getElementById('recipient-section');
    const verificationSection = document.getElementById('verification-section');
    
    // Elements that are required when email is enabled
    const emailRequiredFields = [
        document.getElementById('firstname'),
        document.getElementById('email'),
        document.getElementById('other_firstname'),
        document.getElementById('other_email'),
        document.getElementById('color')
    ];
    
    // Elements that should be hidden when email is disabled
    const emailDependentElements = [senderSection, recipientSection, verificationSection];
    
    // Initialize tooltips
    const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipElements.forEach(element => {
        new bootstrap.Tooltip(element);
    });
    
    // Handle email toggle
    function updateEmailDependentFields() {
        const emailEnabled = emailToggle.checked;
        
        // Update hidden field for backend (send empty string when email enabled, "true" when disabled)
        skipEmailHidden.value = emailEnabled ? '' : 'true';
        
        // Show/hide email-dependent sections
        emailDependentElements.forEach(element => {
            if (emailEnabled) {
                element.style.display = 'block';
                element.setAttribute('aria-hidden', 'false');
            } else {
                element.style.display = 'none';
                element.setAttribute('aria-hidden', 'true');
            }
        });
        
        // Update required attributes and clear values when hiding
        emailRequiredFields.forEach(field => {
            if (emailEnabled) {
                field.setAttribute('required', 'required');
            } else {
                field.removeAttribute('required');
                field.value = '';
                field.classList.remove('is-invalid');
            }
        });
        
        // Visual indicators are now handled by showing/hiding entire sections
    }
    
    // Email toggle event listener
    emailToggle.addEventListener('change', updateEmailDependentFields);
    
    // Initialize on page load
    updateEmailDependentFields();
    
    // Form validation
    form.addEventListener('submit', function(event) {
        let isValid = true;
        
        // Clear previous validation states
        form.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        
        // Validate required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Validate email fields
        const emailFields = form.querySelectorAll('input[type="email"][required]');
        emailFields.forEach(field => {
            if (field.value && !field.checkValidity()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Validate color field pattern
        const colorField = document.getElementById('color');
        if (colorField.hasAttribute('required') && colorField.value) {
            const pattern = new RegExp(colorField.getAttribute('pattern'));
            if (!pattern.test(colorField.value)) {
                colorField.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
            
            // Focus first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
            }
        }
        
        form.classList.add('was-validated');
    });
});
</script>

<style>
/* Modern gradient background */
.back {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    background-attachment: fixed;
    position: relative;
}

.back::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

/* Enhanced container */
.container-main {
    max-width: 900px;
    border-radius: 24px !important;
    backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.95) !important;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 32px 64px rgba(0, 0, 0, 0.15), 
                0 0 0 1px rgba(255, 255, 255, 0.05) !important;
    position: relative;
    z-index: 1;
}

/* Enhanced page title */
h2 {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 700;
    font-size: 2.2rem;
    text-align: center;
    margin-bottom: 2.5rem !important;
}

/* Modern section styling */
.section-group {
    margin-bottom: 2.5rem;
    padding: 2rem;
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    border: 1px solid rgba(108, 117, 125, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
    position: relative;
    overflow: hidden;
}

.section-group::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
}

.section-title::before {
    content: '';
    width: 6px;
    height: 6px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 50%;
    margin-right: 12px;
}

/* Enhanced form controls */
.form-control {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
    background: #fff;
    transform: translateY(-1px);
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
}

/* Enhanced button styling */
.btn-success {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 16px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

/* Toggle switch enhancement */
.form-check-input {
    border-radius: 2em;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-label {
    font-weight: 500;
    color: #2c3e50;
}

/* Tooltip styling */
.btn-link {
    color: #667eea;
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-link:hover {
    color: #764ba2;
    transform: scale(1.1);
}

/* Enhanced form text */
.form-text {
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

/* Validation styles */
.invalid-feedback {
    display: block;
    color: #e74c3c;
    font-weight: 500;
}

.was-validated .form-control:invalid {
    border-color: #e74c3c;
    box-shadow: 0 0 0 0.25rem rgba(231, 76, 60, 0.15);
}

.was-validated .form-control:valid {
    border-color: #27ae60;
    box-shadow: 0 0 0 0.25rem rgba(39, 174, 96, 0.15);
}

/* Responsive design */
@media (max-width: 768px) {
    .container-main {
        margin: 1rem !important;
        padding: 1.5rem !important;
        border-radius: 16px !important;
    }
    
    .section-group {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    h2 {
        font-size: 1.8rem;
        margin-bottom: 2rem !important;
    }
    
    .btn-success {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .container-main {
        margin: 0.5rem !important;
        padding: 1rem !important;
    }
    
    .section-group {
        padding: 1rem;
    }
}

/* Animation for page load */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.container-main {
    animation: fadeInUp 0.6s ease-out;
}

/* Enhanced alert styling */
.alert-danger {
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #ffe6e6, #ffcccc);
    color: #c53030;
    border-left: 4px solid #e53e3e;
    box-shadow: 0 4px 16px rgba(229, 62, 62, 0.1);
}
</style>

</body>
</html>